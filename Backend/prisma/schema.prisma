
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") 
  // ^^^ No Prisma 5, a URL fica aqui mesmo.
}

enum Role {
  PATIENT
  PROFESSIONAL
  ADMIN
}

enum AppointmentStatus {
  PENDING_PAYMENT
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELED
}

// --- AUTENTICAÇÃO E USUÁRIOS ---
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  role          Role
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  
  // Relacionamentos
  patient       Patient?
  professional  Professional?
  auditLogs     AuditLog[]
}

model Patient {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id])
  fullName        String
  cpf             String   @unique
  phone           String
  birthDate       DateTime
  stripeCustomerId String? // ou Pagarme ID

  appointments    Appointment[]
  medicalRecords  MedicalRecord[]
}

model Professional {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id])
  fullName        String
  licenseNumber   String   // CRM
  bio             String?  @db.Text
  avatarUrl       String?
  price           Decimal  @db.Decimal(10, 2)
  isVerified      Boolean  @default(false)
  
  specialties     ProfessionalSpecialty[]
  appointments    Appointment[]
  availability    AvailabilitySlot[]
  medicalRecords  MedicalRecord[]
}

// --- ESPECIALIDADES ---
model Specialty {
  id            Int      @id @default(autoincrement())
  name          String
  professionals ProfessionalSpecialty[]
}

model ProfessionalSpecialty {
  professionalId String
  specialtyId    Int
  professional   Professional @relation(fields: [professionalId], references: [id])
  specialty      Specialty    @relation(fields: [specialtyId], references: [id])
  
  @@id([professionalId, specialtyId])
}

// --- CORE: AGENDAMENTOS ---
model Appointment {
  id             String            @id @default(uuid())
  patientId      String
  professionalId String
  patient        Patient           @relation(fields: [patientId], references: [id])
  professional   Professional      @relation(fields: [professionalId], references: [id])
  
  scheduledAt    DateTime
  status         AppointmentStatus @default(PENDING_PAYMENT)
  price          Decimal           @db.Decimal(10, 2)
  
  videoRoomUrl   String?
  
  medicalRecord  MedicalRecord?
  createdAt      DateTime          @default(now())
}

model AvailabilitySlot {
  id             String       @id @default(uuid())
  professionalId String
  professional   Professional @relation(fields: [professionalId], references: [id])
  dayOfWeek      Int          // 0-6
  startTime      String       // "09:00"
  endTime        String       // "12:00"
}

// --- SAÚDE E AUDITORIA ---
model MedicalRecord {
  id             String       @id @default(uuid())
  appointmentId  String       @unique
  appointment    Appointment  @relation(fields: [appointmentId], references: [id])
  
  patientId      String
  patient        Patient      @relation(fields: [patientId], references: [id])
  professionalId String
  professional   Professional @relation(fields: [professionalId], references: [id])
  
  anamnesis      String       @db.Text
  diagnosis      String?      @db.Text
  prescriptionUrl String?
  
  createdAt      DateTime     @default(now())
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String
  targetId  String?
  ipAddress String?
  timestamp DateTime @default(now())
}
